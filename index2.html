<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ ãƒ‡ãƒ¢ - Ethereum Sepolia</title>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/web3modal@1.9.12/dist/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        h1 {
            color: #2d3748;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #718096;
            font-size: 1.1em;
        }
        
        .section {
            background: #f7fafc;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 4px solid #667eea;
        }
        
        h2 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        h3 {
            color: #4a5568;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .status-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            margin-bottom: 15px;
        }
        
        .status-connected {
            color: #48bb78;
            font-weight: bold;
        }
        
        .status-disconnected {
            color: #f56565;
        }
        
        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin: 5px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        input[type="file"] {
            margin: 15px 0;
            padding: 10px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
        }
        
        .preview-container {
            margin: 20px 0;
            text-align: center;
        }
        
        .preview {
            max-width: 300px;
            max-height: 300px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .nft-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .nft-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        
        .nft-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .nft-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .nft-id {
            font-weight: bold;
            color: #667eea;
            text-align: center;
        }
        
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .alert-success {
            background: #c6f6d5;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }
        
        .alert-error {
            background: #fed7d7;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }
        
        .alert-info {
            background: #bee3f8;
            color: #2c5282;
            border-left: 4px solid #4299e1;
        }
        
        .log-container {
            background: #1a202c;
            color: #68d391;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #2d3748;
        }
        
        .log-error {
            color: #fc8181;
        }
        
        .log-success {
            color: #68d391;
        }
        
        .log-info {
            color: #90cdf4;
        }
        
        .qr-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .qr-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        
        .qr-content canvas {
            margin: 20px 0;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .demo-info {
            background: #edf2f7;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .demo-info ul {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .demo-info li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ NFT ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ ãƒ‡ãƒ¢</h1>
            <p class="subtitle">Ethereum Sepolia ãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆå®Ÿè¨¼å®Ÿé¨“</p>
        </div>

        <div class="demo-info">
            <h3>ğŸ“Œ ãƒ‡ãƒ¢ã®æ¦‚è¦</h3>
            <ul>
                <li>ãƒ–ãƒ­ãƒƒã‚¯ãƒã‚§ãƒ¼ãƒ³ä¸Šã§NFTï¼ˆãƒ‡ã‚¸ã‚¿ãƒ«è³‡ç”£ã®æ‰€æœ‰æ¨©ï¼‰ã‚’ç™ºè¡Œãƒ»ç®¡ç†</li>
                <li>ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã«ã‚ˆã‚Šè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹å‡¦ç†ã‚’ä½“é¨“</li>
                <li>ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®é€æ˜æ€§ã¨æ”¹ã–ã‚“ä¸å¯èƒ½æ€§ã‚’ç¢ºèª</li>
            </ul>
        </div>

        <!-- ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>1ï¸âƒ£ ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶š</h2>
            <div class="status-box">
                <div id="walletStatus" class="status-disconnected">
                    âŒ ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæœªæ¥ç¶š
                </div>
                <div id="networkInfo" style="margin-top: 10px; color: #718096;"></div>
            </div>
            <button id="connectMetaMask">ğŸ¦Š MetaMaskæ¥ç¶šï¼ˆPCï¼‰</button>
            <button id="connectWalletConnect">ğŸ“± WalletConnectï¼ˆã‚¹ãƒãƒ›ï¼‰</button>
            <div id="walletDetails" style="margin-top: 15px;"></div>
        </div>

        <!-- ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>2ï¸âƒ£ ã‚¹ãƒãƒ¼ãƒˆã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆè¨­å®š</h2>
            <p style="color: #718096; margin-bottom: 15px;">RemixIDEã§ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›</p>
            <input type="text" id="contractAddress" placeholder="0x... (ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹)">
            <button id="setContract">ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆæ¥ç¶š</button>
            <div id="contractStatus" style="margin-top: 15px;"></div>
        </div>

        <!-- NFTç™ºè¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>3ï¸âƒ£ NFTç™ºè¡Œï¼ˆãƒŸãƒ³ãƒˆï¼‰</h2>
            <h3>ä»•æ§˜1: ç”»åƒã‚’NFTåŒ–</h3>
            <input type="file" id="imageUpload" accept="image/*">
            <div id="imagePreview" class="preview-container"></div>
            <button id="mintNFT" disabled>ğŸ¯ NFTã‚’ç™ºè¡Œã™ã‚‹</button>
            <div id="mintResult"></div>
        </div>

        <!-- æ‰€æœ‰NFTè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>4ï¸âƒ£ æ‰€æœ‰NFTä¸€è¦§</h2>
            <button id="refreshNFTs">ğŸ”„ ãƒªã‚¹ãƒˆæ›´æ–°</button>
            <div id="ownedNFTs">
                <p style="color: #718096;">ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆæ¥ç¶šå¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™</p>
            </div>
        </div>

        <!-- NFTç§»è»¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>5ï¸âƒ£ NFTç§»è»¢ï¼ˆãƒˆãƒ©ãƒ³ã‚¹ãƒ•ã‚¡ãƒ¼ï¼‰</h2>
            <h3>ä»•æ§˜2: æ‰€æœ‰æ¨©ã®ç§»è»¢</h3>
            <input type="number" id="tokenId" placeholder="ç§»è»¢ã™ã‚‹NFTã®Token ID" min="0">
            <input type="text" id="recipientAddress" placeholder="ç§»è»¢å…ˆã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ (0x...)">
            <button id="transferNFT" disabled>â¡ï¸ NFTã‚’ç§»è»¢ã™ã‚‹</button>
            <div id="transferResult"></div>
        </div>

        <!-- å®Ÿè¡Œãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
            <h2>ğŸ“œ å®Ÿè¡Œãƒ­ã‚°</h2>
            <p style="color: #718096; margin-bottom: 10px;">ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†ã®è©³ç´°</p>
            <div id="executionLog" class="log-container"></div>
            <button id="clearLog" style="margin-top: 10px;">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>

        <!-- QRã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="qrModal" class="qr-modal">
            <div class="qr-content">
                <h3>ğŸ“± ã‚¹ãƒãƒ›ã§ã‚¹ã‚­ãƒ£ãƒ³</h3>
                <div id="qrCode"></div>
                <button id="closeQR">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆABIå®šç¾©
        const CONTRACT_ABI = [
            "function mintNFT(address to, string memory imageURI) public returns (uint256)",
            "function transferNFT(address to, uint256 tokenId) public",
            "function tokenURI(uint256 tokenId) public view returns (string memory)",
            "function ownerOf(uint256 tokenId) public view returns (address)",
            "function balanceOf(address owner) public view returns (uint256)",
            "function getOwnedTokens(address owner) public view returns (uint256[] memory)",
            "event NFTMinted(address indexed to, uint256 tokenId, string imageURI)",
            "event NFTTransferred(address indexed from, address indexed to, uint256 tokenId)"
        ];

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let provider = null;
        let signer = null;
        let contract = null;
        let walletAddress = null;
        let web3Modal = null;

        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            initWeb3Modal();
            setupEventListeners();
            addLog('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†', 'info');
        });

        // Web3ModalåˆæœŸåŒ–
        function initWeb3Modal() {
            const Web3Modal = window.Web3Modal.default;
            const WalletConnectProvider = window.WalletConnectProvider.default;

            const providerOptions = {
                walletconnect: {
                    package: WalletConnectProvider,
                    options: {
                        infuraId: "9aa3d95b3bc440fa88ea12eaa4456161",
                        rpc: {
                            11155111: "https://sepolia.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161"
                        }
                    }
                }
            };

            web3Modal = new Web3Modal({
                network: "sepolia",
                cacheProvider: false,
                providerOptions,
                theme: {
                    background: "rgb(39, 49, 56)",
                    main: "rgb(199, 199, 199)",
                    secondary: "rgb(136, 136, 136)",
                    border: "rgba(195, 195, 195, 0.14)",
                    hover: "rgb(16, 26, 32)"
                }
            });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            document.getElementById('connectMetaMask').addEventListener('click', connectMetaMask);
            document.getElementById('connectWalletConnect').addEventListener('click', connectWalletConnect);
            document.getElementById('setContract').addEventListener('click', setContract);
            document.getElementById('mintNFT').addEventListener('click', mintNFT);
            document.getElementById('transferNFT').addEventListener('click', transferNFT);
            document.getElementById('refreshNFTs').addEventListener('click', loadOwnedNFTs);
            document.getElementById('clearLog').addEventListener('click', clearLog);
            document.getElementById('closeQR').addEventListener('click', closeQRModal);
            document.getElementById('imageUpload').addEventListener('change', handleImageUpload);
        }

        // ãƒ­ã‚°ç®¡ç†
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('executionLog');
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('executionLog').innerHTML = '';
            addLog('ãƒ­ã‚°ã‚¯ãƒªã‚¢', 'info');
        }

        // MetaMaskæ¥ç¶š
        async function connectMetaMask() {
            try {
                addLog('MetaMaskæ¥ç¶šé–‹å§‹...', 'info');
                
                if (!window.ethereum) {
                    alert('MetaMaskãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                    addLog('MetaMaskæœªæ¤œå‡º', 'error');
                    return;
                }

                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                
                await setupWallet();
                
            } catch (error) {
                addLog(`MetaMaskæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                alert('MetaMaskæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // WalletConnectæ¥ç¶š
        async function connectWalletConnect() {
            try {
                addLog('WalletConnectæ¥ç¶šé–‹å§‹...', 'info');
                
                const instance = await web3Modal.connectTo("walletconnect");
                provider = new ethers.providers.Web3Provider(instance);
                
                await setupWallet();
                
            } catch (error) {
                addLog(`WalletConnectæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                alert('WalletConnectæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆè¨­å®š
        async function setupWallet() {
            try {
                const network = await provider.getNetwork();
                
                if (network.chainId !== 11155111) {
                    alert('Sepoliaãƒ†ã‚¹ãƒˆãƒãƒƒãƒˆã«åˆ‡ã‚Šæ›¿ãˆã¦ãã ã•ã„');
                    addLog('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: Sepoliaä»¥å¤–ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯', 'error');
                    
                    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ‡ã‚Šæ›¿ãˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }], // Sepolia
                        });
                    } catch (switchError) {
                        console.error(switchError);
                    }
                    return;
                }

                signer = provider.getSigner();
                walletAddress = await signer.getAddress();
                
                // UIæ›´æ–°
                document.getElementById('walletStatus').innerHTML = 
                    `<span class="status-connected">âœ… æ¥ç¶šæ¸ˆã¿: ${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}</span>`;
                
                document.getElementById('networkInfo').textContent = 
                    `ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯: Sepolia (Chain ID: ${network.chainId})`;
                
                const balance = await provider.getBalance(walletAddress);
                document.getElementById('walletDetails').innerHTML = 
                    `<div class="alert alert-info">
                        æ®‹é«˜: ${ethers.utils.formatEther(balance)} ETH
                    </div>`;
                
                addLog(`ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ¥ç¶šæˆåŠŸ: ${walletAddress}`, 'success');
                
                // NFTãƒªã‚¹ãƒˆæ›´æ–°
                if (contract) {
                    await loadOwnedNFTs();
                }
                
            } catch (error) {
                addLog(`ã‚¦ã‚©ãƒ¬ãƒƒãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                throw error;
            }
        }

        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆè¨­å®š
        async function setContract() {
            const address = document.getElementById('contractAddress').value;
            
            if (!address) {
                alert('ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!ethers.utils.isAddress(address)) {
                alert('æœ‰åŠ¹ãªã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            if (!signer) {
                alert('å…ˆã«ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚’æ¥ç¶šã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                addLog(`ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆæ¥ç¶šä¸­: ${address}`, 'info');
                
                contract = new ethers.Contract(address, CONTRACT_ABI, signer);
                
                // æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆä½•ã‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã‚“ã§ã¿ã‚‹ï¼‰
                const testBalance = await contract.balanceOf(walletAddress);
                
                document.getElementById('contractStatus').innerHTML = 
                    `<div class="alert alert-success">
                        âœ… ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆæ¥ç¶šæˆåŠŸ<br>
                        ã‚¢ãƒ‰ãƒ¬ã‚¹: ${address}
                    </div>`;
                
                // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
                document.getElementById('mintNFT').disabled = false;
                document.getElementById('transferNFT').disabled = false;
                
                addLog(`ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆæ¥ç¶šå®Œäº†`, 'success');
                
                // NFTãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
                await loadOwnedNFTs();
                
            } catch (error) {
                document.getElementById('contractStatus').innerHTML = 
                    `<div class="alert alert-error">æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                addLog(`ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆæ¥ç¶šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('imagePreview').innerHTML = 
                        `<img src="${e.target.result}" class="preview">
                         <p style="margin-top: 10px; color: #718096;">ãƒ•ã‚¡ã‚¤ãƒ«: ${file.name}</p>`;
                };
                reader.readAsDataURL(file);
                addLog(`ç”»åƒé¸æŠ: ${file.name}`, 'info');
            }
        }

        // NFTç™ºè¡Œ
        async function mintNFT() {
            const fileInput = document.getElementById('imageUpload');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                addLog('NFTç™ºè¡Œå‡¦ç†é–‹å§‹', 'info');
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const imageData = e.target.result;
                    
                    document.getElementById('mintResult').innerHTML = 
                        `<div class="alert alert-info">
                            ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡ä¸­... <span class="loading"></span>
                        </div>`;
                    
                    addLog('ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡ä¸­...', 'info');
                    
                    const tx = await contract.mintNFT(walletAddress, imageData);
                    
                    addLog(`TXãƒãƒƒã‚·ãƒ¥: ${tx.hash}`, 'info');
                    
                    document.getElementById('mintResult').innerHTML = 
                        `<div class="alert alert-info">
                            ãƒã‚¤ãƒ‹ãƒ³ã‚°ä¸­... <span class="loading"></span><br>
                            <small>TX: ${tx.hash.slice(0, 10)}...</small>
                        </div>`;
                    
                    const receipt = await tx.wait();
                    
                    // ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰TokenIDå–å¾—
                    const event = receipt.events?.find(e => e.event === 'NFTMinted');
                    const tokenId = event?.args?.tokenId?.toString();
                    
                    document.getElementById('mintResult').innerHTML = 
                        `<div class="alert alert-success">
                            âœ… NFTç™ºè¡ŒæˆåŠŸï¼<br>
                            Token ID: ${tokenId}<br>
                            <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank">
                                Etherscanã§ç¢ºèª â†’
                            </a>
                        </div>`;
                    
                    addLog(`NFTç™ºè¡Œå®Œäº† (Token ID: ${tokenId})`, 'success');
                    
                    // ãƒªã‚¹ãƒˆæ›´æ–°
                    await loadOwnedNFTs();
                    
                    // å…¥åŠ›ã‚¯ãƒªã‚¢
                    fileInput.value = '';
                    document.getElementById('imagePreview').innerHTML = '';
                };
                reader.readAsDataURL(file);
                
            } catch (error) {
                document.getElementById('mintResult').innerHTML = 
                    `<div class="alert alert-error">
                        âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}
                    </div>`;
                addLog(`NFTç™ºè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // NFTç§»è»¢
        async function transferNFT() {
            const tokenId = document.getElementById('tokenId').value;
            const recipient = document.getElementById('recipientAddress').value;
            
            if (!tokenId || !recipient) {
                alert('Token IDã¨ç§»è»¢å…ˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!ethers.utils.isAddress(recipient)) {
                alert('æœ‰åŠ¹ãªã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            try {
                addLog(`NFTç§»è»¢é–‹å§‹: Token ${tokenId} â†’ ${recipient}`, 'info');
                
                document.getElementById('transferResult').innerHTML = 
                    `<div class="alert alert-info">
                        ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é€ä¿¡ä¸­... <span class="loading"></span>
                    </div>`;
                
                const tx = await contract.transferNFT(recipient, tokenId);
                
                addLog(`TXãƒãƒƒã‚·ãƒ¥: ${tx.hash}`, 'info');
                
                document.getElementById('transferResult').innerHTML = 
                    `<div class="alert alert-info">
                        ãƒã‚¤ãƒ‹ãƒ³ã‚°ä¸­... <span class="loading"></span><br>
                        <small>TX: ${tx.hash.slice(0, 10)}...</small>
                    </div>`;
                
                await tx.wait();
                
                document.getElementById('transferResult').innerHTML = 
                    `<div class="alert alert-success">
                        âœ… NFTç§»è»¢æˆåŠŸï¼<br>
                        Token ID ${tokenId} â†’ ${recipient.slice(0, 6)}...${recipient.slice(-4)}<br>
                        <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank">
                            Etherscanã§ç¢ºèª â†’
                        </a>
                    </div>`;
                
                addLog(`NFTç§»è»¢å®Œäº†`, 'success');
                
                // ãƒªã‚¹ãƒˆæ›´æ–°
                await loadOwnedNFTs();
                
                // å…¥åŠ›ã‚¯ãƒªã‚¢
                document.getElementById('tokenId').value = '';
                document.getElementById('recipientAddress').value = '';
                
            } catch (error) {
                document.getElementById('transferResult').innerHTML = 
                    `<div class="alert alert-error">
                        âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}
                    </div>`;
                addLog(`NFTç§»è»¢ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // æ‰€æœ‰NFTä¸€è¦§å–å¾—
        async function loadOwnedNFTs() {
            if (!contract || !walletAddress) {
                document.getElementById('ownedNFTs').innerHTML = 
                    '<p style="color: #718096;">ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã¨ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’æ¥ç¶šã—ã¦ãã ã•ã„</p>';
                return;
            }
            
            try {
                addLog('NFTãƒªã‚¹ãƒˆå–å¾—ä¸­...', 'info');
                
                const tokenIds = await contract.getOwnedTokens(walletAddress);
                
                const nftDiv = document.getElementById('ownedNFTs');
                
                if (tokenIds.length === 0) {
                    nftDiv.innerHTML = '<p style="color: #718096;">æ‰€æœ‰ã—ã¦ã„ã‚‹NFTã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                    addLog('æ‰€æœ‰NFT: 0å€‹', 'info');
                } else {
                    let html = `<p style="margin-bottom: 15px;">æ‰€æœ‰NFTæ•°: ${tokenIds.length}å€‹</p>`;
                    html += '<div class="nft-grid">';
                    
                    for (const tokenId of tokenIds) {
                        const uri = await contract.tokenURI(tokenId);
                        html += `
                            <div class="nft-card">
                                <img src="${uri}" alt="NFT ${tokenId}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgZmlsbD0iI2VlZSIvPjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjEwMCIgeT0iNzUiIHN0eWxlPSJmaWxsOiNhYWE7Zm9udC13ZWlnaHQ6Ym9sZDtmb250LXNpemU6MTJweDtmb250LWZhbWlseTpBcmlhbCxIZWx2ZXRpY2Esc2Fucy1zZXJpZjtkb21pbmFudC1iYXNlbGluZTpjZW50cmFsIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4='">
                                <div class="nft-id">Token ID: ${tokenId.toString()}</div>
                            </div>
                        `;
                    }
                    
                    html += '</div>';
                    nftDiv.innerHTML = html;
                    
                    addLog(`æ‰€æœ‰NFT: ${tokenIds.length}å€‹èª­ã¿è¾¼ã¿å®Œäº†`, 'success');
                }
                
            } catch (error) {
                document.getElementById('ownedNFTs').innerHTML = 
                    `<div class="alert alert-error">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}</div>`;
                addLog(`NFTãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // QRãƒ¢ãƒ¼ãƒ€ãƒ«
        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
        }
    </script>
</body>
</html>
